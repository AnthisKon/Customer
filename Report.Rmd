---
title: "Data Analyst @ Gousto"
author: "Konstantinos Anthis"
date: "01 December 2018"
output: 
   html_document:
    code_folding: hide
    keep_md: true
    toc: true
    number_sections: yes
    toc_depth: 3
    toc_float:
       toc_collapsed: false
       smooth_scroll: false  
    highlight: espresso
    theme: simplex
    df_print: paged
    css: custom.css
    fig_caption: true
    encoding: UTF-8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<script>
$(document).ready(function() {
$head = $('#header');
$head.prepend('<img src=\"image.jpg\" style=\"float: right;width: 200px;\"/>')
});
</script>



```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
Sys.setlocale("LC_ALL","English")
library(data.table)
library(tidyverse)
library(lubridate)
library(plotly)
library(kableExtra)
library(knitr)
library(DT)
```

```{r read data, message=FALSE, warning=FALSE, include=FALSE}
gousto <- fread("orders.csv" )
gousto = gousto %>% mutate(payment_made = dmy(payment_made))
```
# Approach and Actions {.tabset .tabset-fade .tabset-pills}

## Approach

The data set of this exercise contains information about **852,761 orders** made by **156,189 customers** from *January 2014 to January 2016*. There are only six features for each order in the initial data set: Order ID, User ID , Period ID, Payment Date, Due Ammount and Paid Ammmount. 

I included findings that are important and support my proposals.

**I am assuming that the orders are about gousto's product.**


My approach is to analyse this dataset looking at two sides:


**1. By customer**

  - Create a data set aggregating data by customer and engineering new features
  - New features: Tenure, Frequency of purchase, Monetary value, recency of purchase, Churn and Retention,
    cost of the customer and net value of the customer.
    
**2. By order**

  - Create some descriptive measures to find out information for orders per year, month, week day or period
  
  
  

## Actions



Proposed actions: 

1. **Create a relationship with new customers to retain new customers for more than a month: **

    * Analyze what channels of communication with customer are available and how the customer responds to each channel
    * Make special offers for new customers (what about cooking tools or wine to company the meal?). (As I was writing this I saw your "Get 35% off all boxes in your first month" offer in gousto website)
    * Use the customer base to create a community where the customers can help each other, welcome new customers, share experiences and cooking 'secrets', opinions and recomendations about recipes etc
    * 'Personal chef' option for new customers: A chef/cook goes to the customer's location in order to cook with the customer (like a live course). This service can be given for free during the first week or charging a small ammount

2. **Special offers and activities during the weekend:**

    * Saturday and Sunday have the fewest orders with the highest avegare ammount paid and costs at the same level as the rest of the days
    * Weekend community cooking competitions: Each customer can cook and share the dish online in order to get votes about the appearence of the dish, the creativity etc. Highest voted customers get a gift from gousto. 
    * Even on site competitions: Create a space for cooking  courses and competitions for the weekend


*Note: Some of these actions may be already in place*





# Orders Analysis {.tabset .tabset-fade .tabset-pills}

## Week Days orders

* **During the Weekend (Saturday and Sunday) customers seem to spend more on average than during other days:**

```{r , fig.align='center', fig.width=6, fig.height=4, fig.cap="Weekend seems to have higher payments compared to other weekdays. Increasing the ammount of orders during the weekend is the way to go"}
gousto  %>% mutate(payment_made = factor(weekdays(payment_made), 
                                         c('Monday',
                                           'Tuesday',
                                           'Wednesday',
                                           'Thursday',
                                           'Friday',
                                           'Saturday',
                                           'Sunday'))) %>% 
  ggplot(aes(x = payment_made, 
             y = total_paid,
             fill = payment_made)) +
  geom_boxplot() +
  theme_minimal() +
  scale_fill_brewer(palette = 'Dark2', 
                    name = 'Weekday') +
  ggtitle('Payments per Weekday') +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = 'none')
```

* At the same time, during the weekend the ammount of orders reduces significantly:

```{r}
gousto  %>% group_by(Weekday = weekdays(payment_made)) %>% 
  summarise(Orders = format(n(), 
                            big.mark = ',',
                            decimal.mark = '.'), 
            'Avg Paid' = paste(format(mean(total_paid), 
                                      big.mark = ',',
                                      decimal.mark = '.', 
                                      digits = 3),
                               '£'),
            'Avg Due' = paste(format(mean(total_due), 
                                     big.mark = ',',
                                     decimal.mark = '.', 
                                     digits = 3),
                              "£"),
            'TTL Paid' = paste(format(sum(total_paid), 
                                     big.mark = ',',
                                     decimal.mark = '.'),
                              "£"),
            'TTL Due' = paste(format(sum(total_due), 
                                     big.mark = ',',
                                     decimal.mark = '.'),
                              "£")) 
  
```


## Orders by month

The number of Orders increase during December 

```{r}
gousto  %>% 
  group_by(Month = month.abb[month(payment_made)]) %>% 
  summarise(Orders = n(), 
            Avg_Paid = mean(total_paid),
            
            Avg_Due = mean(total_due),
            Paid = sum(total_paid),
            Due = sum(total_due))  %>% 
  ggplot(aes(x = Month, 
             y = Orders)) + 
  geom_bar(fill = "#CD3700", 
           stat = "identity") +
  theme_minimal() +
  ggtitle('Number of orders per month')+
  theme(plot.title = element_text(hjust = 0.5))
```




# Customers Analysis {.tabset .tabset-fade .tabset-pills}

The orders data set is aggregated by customers in orders to analyze customer behaviours, detect problems and propose actions:



**The most important problem discovered by analysing customer retention and churn.**

```{r}
today = dmy('01-01-2017')

Customer <- gousto %>% 
  group_by(user_id) %>% 
  summarise(Frequency = n(), 
            Last_pay = max(payment_made),
            First_pay = min(payment_made),
            Recency = difftime(today , 
                               max(payment_made) ,
                               units = c("days")),
            Paid = sum(total_paid),
            Due = sum(total_due),
            Max_Paid = max(total_paid),
            Max_Due = max(total_due),
            Avg_Paid = mean(total_paid),
            Avg_due = mean(total_due),
            Purchased_Again = ifelse((year(First_pay) < year(Last_pay)),
                                     'YES',
                                     "NO"),
            Tenure = difftime(Last_pay, 
                              First_pay,
                              c("days")),
            Diff = Paid - Due,
            Same_month_churn = case_when(Tenure == 0 ~ '0',
                                         Tenure <= 30 ~ '1',
                                         Tenure > 30 ~ '2')
            )
```



## **The Problem: Churn, Retention**
* **Major Problem:** **~50%** of the customers churn **at the first day of their order** and **~80%** of the customers churned **the same month they purchased for the first time**: 
```{r}
Customer %>% 
  group_by(Retention = factor(Same_month_churn, 
                              labels = c('Same day churn',
                                         'Same month churn',
                                         'Retained more than 1 month'))) %>% 
  summarise(Count = n(), 
            'Average net Value' = format(mean(Diff),
                                         decimal.mark = '.',
                                         digits = 3)) %>% 
  mutate('Base Percentage' = paste(format((Count/sum(Count))*100,
                                          decimal.mark = '.',
                                          digits = 4),
                                   '%'),
         Count = format(Count, 
                        big.mark = ',')) %>% 
  kable('html', align = 'rccc') %>% 
  kable_styling(bootstrap_options = "striped")
```



## New Customers (Acquisition) per year

**How many customers are acquired each year ??**
```{r}
Customer %>%
  group_by('New Customers' = year(First_pay)) %>% 
  summarise( Count = format(n(),
                            big.mark = ',') ) %>% 
  kable('html', align = 'cc') %>% 
  kable_styling(bootstrap_options = "striped")

```



## Yearly Retention

The table bellow shows the first year a customer made the first purchase and the last. We can see how many customers churned the same year they purchased for the first time and 
```{r}
Customer %>%
  group_by('First Purchase' = year(First_pay), 
           'Last Purchase'= year(Last_pay)) %>% 
  summarise( Customers = format(n(), 
                                big.mark = ',')) %>% 
  kable('html', align = 'ccc') %>% 
  kable_styling(bootstrap_options = "striped")
```


## Sample Customer Data

Just a sample o the customer data:

```{r message=FALSE, warning=FALSE}
datatable(head(Customer,200))
```



# Next Steps

There is much more information that can be mined from this dataset in order to get a better understanding about the customer behaviour. As next step, I would break the customer base into segments in order to look at them under every possible perspective. This could reveal customer segment with a special behaviour that would lead us to relevant actions. 
 




